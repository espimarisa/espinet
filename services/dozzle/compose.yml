---
services:
    ###############################################################################
    # Dozzle: Docker log viewer.                                                 #
    ##############################################################################

    dozzle:
        image: ghcr.io/amir20/dozzle:v8.13.14
        container_name: dozzle
        hostname: dozzle
        restart: unless-stopped
        depends_on:
            socket-proxy:
                condition: service_healthy
                restart: true
        environment:
            DOCKER_HOST: "tcp://socket-proxy:2375" # Connect to the socket proxy.
            DOZZLE_ENABLE_ACTIONS: "true" # Enables container actions.
        labels:
            caddy: "dozzle.${INTERNAL_DOMAIN}" # Reverse proxy to the internal domain.
            caddy.import: "internal dozzle:8080" # Reverse proxy internal traffic.
            caddy.tls.ca: "https://acme.zerossl.com/v2/DV90" # Use ZeroSSL for certificates.
            caddy.tls.dns: "cloudflare $CLOUDFLARE_API_TOKEN" # Use Cloudflare for DNS challenges.
            caddy.tls.protocols: "tls1.3" # Require TLS 1.3.
        healthcheck:
            timeout: 3s
            test: ["CMD", "/dozzle", "healthcheck"]
        networks:
            - caddy
            - socket-proxy
        ports:
            - ${DOZZLE_PORT:-8082}:8080/tcp # Web interface.
        security_opt:
            - no-new-privileges:true
        volumes:
            - dozzle:/data

networks:
    caddy:
        driver: bridge
        enable_ipv6: false
        external: true
        name: caddy-network # $ docker network create --ipv6=false caddy-network
    socket-proxy:
        driver: bridge
        enable_ipv6: false
        external: true # $ docker network create --ipv6=false --internal=true socket-proxy-network
        internal: true # Isolates the network from the outside.
        name: socket-proxy-network # Internal-only network used only for Socket Proxy traffic.

volumes:
    dozzle:
        external: true
        name: dozzle-volume # $ docker volume create dozzle-volume
