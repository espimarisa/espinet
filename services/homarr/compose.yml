services:
    homarr:
        container_name: "homarr"
        image: "ghcr.io/homarr-labs/homarr:latest"
        hostname: "homarr"
        restart: "unless-stopped"
        security_opt: ["no-new-privileges:true"]
        depends_on:
            socket-proxy:
                condition: "service_started" # Require socket-proxy to be healthy before connecting.
                restart: "true"
        environment:
            DOCKER_HOSTNAMES: "socket-proxy" # Connect to the socket proxy.
            DOCKER_PORTS: "2375" # Connect to the socket proxy port.
            PGID: "${PGID}" # Group ID to run the container as.
            PUID: "${PUID}" # User ID to run the container as.
            SECRET_ENCRYPTION_KEY: "${HOMARR_ENCRYPTION_KEY}" # Encryption key to use for Homarr.
            TZ: "${TZ}" # Timezone to configure the container to run under.
        labels:
            caddy: "${HOMARR_URL}" # Tells Caddy to reverse proxy to the external Homarr URL.
            caddy.reverse_proxy: "homarr:7575" # Tells Caddy to reverse proxy internal traffic on port 7575.
            caddy.tls.ca: "https://acme.zerossl.com/v2/DV90" # Use ZeroSSL as the CA issuer.
            caddy.tls.dns: "cloudflare $CLOUDFLARE_API_TOKEN" # Use Cloudflare for DNS challenges.
            caddy.tls.protocols: "tls1.3" # Requires clients to support TLS 1.3.
        networks:
            - "external" # External caddy network.
            - "frontend" # Local frontend network.
            - "internal" # Internal-only network.
        ports:
            - "${HOMARR_PORT:-7575}:7575/tcp" # Local web interface.
        volumes:
            - "homarr-appdata:/appdata" # Configuration and data volume.

networks:
    external:
        driver: "bridge"
        external: "true"
        name: "external-network"
    frontend:
        driver: "bridge"
        external: "true"
        name: "frontend-network"
    internal:
        driver: "bridge"
        external: "true"
        name: "internal-network"

volumes:
    homarr-appdata:
        name: "homarr-appdata-volume"
        driver_opts:
            device: "${HOMARR_PATH}" # Root homarr configuration path.
            o: "bind"
            type: "none"
