services:
    snapp:
        container_name: "snapp"
        image: "uraniadev/snapp:latest"
        hostname: "snapp"
        restart: "unless-stopped"
        security_opt: ["no-new-privileges:true"]
        environment:
            ADMIN_PASSWORD: "${SNAPP_PASSWORD:-password}" # Configures the default admin password.
            ADMIN_USERNAME: "${SNAPP_USERNAME:-admin}" # Configures the default admin username.
            ALLOW_UNSECURE_HTTP: "true" # Allow shortening http-only links.
            DATABASE_PROVIDER: "sqlite" # Use SQLite as the database provider.
            DATABASE_URL: "file:./db.sqlite" # Use the local SQLite database.
            DISABLE_HOME: "true" # Disables the default landing page.
            ENABLE_SIGNUP: "false" # Do not allow public signups.
            ENABLED_MFA: "true" # Require MFA for all users.
            ORIGIN: "https://${SNAPP_URL}" # Configure the origin URL to be the published external URL.
            PORT: ${SNAPP_PORT:-3000} # Configures the port to use.
            PUBLIC_URL: "https://${SNAPP_URL}" # Configures the public URL to be the published external URL.
            SMTP_FROM: ${SMTP_SENDER} # External email server sender.
            SMTP_HOST: ${SMTP_HOST} # External email server host.
            SMTP_PASS: ${SMTP_PASSWORD} # External email server password.
            SMTP_PORT: ${SMTP_PORT} # External email server port.
            SMTP_USER: ${SMTP_USERNAME} # External email server username.
            TOKEN_SECRET: "${SNAPP_SECRET}" # Configures the secret to use.
        healthcheck:
            interval: "1m"
            retries: "3"
            start_period: "30s"
            test: ["CMD", "curl", "-f", "http://127.0.0.1:3000/health"]
            timeout: "3s"
        labels:
            caddy: "${SNAPP_URL}" # Tells Caddy to reverse proxy to the external Snapp URL.
            caddy.reverse_proxy: "snapp:3000" # Tells Caddy to reverse proxy internal traffic on port 8096.
            caddy.tls.ca: "https://acme.zerossl.com/v2/DV90" # Use ZeroSSL as the CA issuer.
            caddy.tls.dns: "cloudflare $CLOUDFLARE_API_TOKEN" # Use Cloudflare for DNS challenges.
            caddy.tls.protocols: "tls1.3" # Requires clients to support TLS 1.3.
        networks:
            - "frontend" # Local frontend network.
            - "external" # External Caddy network.
        ports:
            - "${SNAPP_PORT:-3000}:3000/tcp" # Local web interface.
        volumes:
            - "${SNAPP_PATH}/db.sqlite:/app/dbschema/sqlite/prisma/db.sqlite" # Configuration and data volume.

networks:
    frontend:
        driver: "bridge"
        external: "true"
        name: "frontend-network"
    external:
        driver: "bridge"
        external: "true"
        name: "external-network"
