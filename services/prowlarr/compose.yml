---
services:
    ###############################################################################
    # Prowlarr: Indexer manager for 'ARR apps.                                    #
    ##############################################################################

    prowlarr:
        image: lscr.io/linuxserver/prowlarr:latest
        container_name: prowlarr
        network_mode: service:gluetun # Route all traffic through Gluetun.
        restart: unless-stopped
        depends_on:
            gluetun:
                condition: service_healthy
                restart: true
        environment:
            PGID: "${PGID}" # Local group to run as.
            PUID: "${PUID}" # Local user to run as.
            TZ: "${TZ}" # Configures the timezone to use.
            UMASK: "${UMASK}" # Umask to apply to newly created files.
        labels:
            caddy: "prowlarr.${INTERNAL_DOMAIN}" # Reverse proxy to the internal domain.
            caddy.import: "internal gluetun:9696" # Reverse proxy internal traffic.
            caddy.tls.ca: "https://acme.zerossl.com/v2/DV90" # Use ZeroSSL for certificates.
            caddy.tls.dns: "cloudflare $CLOUDFLARE_API_TOKEN" # Use Cloudflare for DNS challenges.
            caddy.tls.protocols: "tls1.3" # Require TLS 1.3.
        healthcheck:
            interval: 1m
            test: "curl -f http://127.0.0.1:9696/ping || exit 1"
        security_opt:
            - no-new-privileges:true
        volumes:
            - downloads:/downloads
            - prowlarr:/config

volumes:
    prowlarr:
        external: true
        name: prowlarr-volume # $ docker volume create prowlarr-volume
    downloads:
        name: downloads-volume
        driver_opts:
            device: "${DOWNLOADS_PATH}" # Root path to store downloaded files into.
            o: bind
            type: none
