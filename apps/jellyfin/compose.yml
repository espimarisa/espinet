services:
  jellyfin:
    container_name: jellyfin
    image: ghcr.io/jellyfin/jellyfin:10.10.7
    env_file: ../../.env
    group_add:
      - "${RENDER_GID}" # Change this to match your "render" host group id and remove this comment.
    hostname: jellyfin
    restart: unless-stopped
    user: ${PGID}:${PUID}
    devices:
      - /dev/dri/renderD128:/dev/dri/renderD128 # Video device passthrough for HW acceleration, /dev/dri/renderD128 should be GPU0.
    environment:
      - JELLYFIN_PublishedServerUrl=https://${PUBLISHED_JELLYFIN_URL} # Sets the autodiscovery URL.
      - TZ=${TZ}
    networks:
      - caddy # External Caddy/reverse proxy network.
      - frontend # Internal network for local web interface access.
      - media # Internal media network.
    ports:
      - ${JELLYFIN_HTTP_PORT:-8096}:8096 # Local Jellyfin web interface.
      - 7359:7359/udp # Local Jellyfin autodiscovery port.
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ${MEDIA_LIBRARY_DIRECTORY}:/library:ro
      - jellyfin-cache:/cache
      - jellyfin:/config
    healthcheck:
      interval: 5m
      retries: 3
      start_period: 1m
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      timeout: 10s
    labels:
      caddy: ${PUBLISHED_JELLYFIN_URL} # Tells Caddy to reverse proxy to the external Jellyfin URL.
      caddy.reverse_proxy: jellyfin:8096 # Tells Caddy to reverse proxy internal traffic on port 8096.
      caddy.tls.ca: https://acme.zerossl.com/v2/DV90 # Use ZeroSSL as the CA issuer.
      caddy.tls.dns: cloudflare $CLOUDFLARE_API_TOKEN # Use Cloudflare for DNS challenges.
      caddy.tls.protocols: tls1.3 # Requires clients to support TLS 1.3.
    security_opt:
      - no-new-privileges:true

networks:
  caddy:
    name: caddy-network
    driver: bridge
    enable_ipv6: false
    external: true
  frontend:
    name: frontend-network
    driver: bridge
    enable_ipv6: false
    external: true
  media:
    name: media-network
    driver: bridge
    enable_ipv6: false
    external: true

volumes:
  jellyfin:
    name: jellyfin-volume
    external: true
  jellyfin-cache:
    name: jellyfin-cache-volume
    external: true
